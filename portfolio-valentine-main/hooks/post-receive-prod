#!/bin/bash

# Hook Git post-receive PRODUCTION
# Fichier: /var/www/portfolio-valentine-prod.git/hooks/post-receive
# Branch: main ‚Üí https://valentine-arnaly.com

WORK_TREE="/var/www/portfolio-valentine-prod"
GIT_DIR="/var/www/portfolio-valentine-prod.git"
SERVICE_NAME="portfolio-valentine-prod"
BRANCH="main"
PORT="3001"
DOMAIN="valentine-arnaly.com"

# Fonction de log avec timestamp
log() {
    echo "[PROD $(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# V√©rifier la branche
while read oldrev newrev refname; do
    if [[ $refname == "refs/heads/$BRANCH" ]]; then
        log "üöÄ D√©ploiement PRODUCTION d√©clench√© (branch: $BRANCH)"
        
        # Checkout des fichiers
        log "üìÅ Mise √† jour des fichiers..."
        git --git-dir=$GIT_DIR --work-tree=$WORK_TREE checkout -f $BRANCH
        
        cd $WORK_TREE
        
        # Installation et build
        log "üì¶ Installation des d√©pendances..."
        npm run install:all > /dev/null 2>&1
        
        if [ $? -ne 0 ]; then
            log "‚ùå ERREUR: Installation des d√©pendances √©chou√©e"
            exit 1
        fi
        
        log "üî® Build de l'application..."
        npm run build > /dev/null 2>&1
        
        if [ $? -ne 0 ]; then
            log "‚ùå ERREUR: Build √©chou√©"
            exit 1
        fi
        
        # Red√©marrage du service
        log "üîÑ Red√©marrage du service PRODUCTION..."
        sudo systemctl restart $SERVICE_NAME
        
        # Test de sant√©
        sleep 5
        log "üè• Test de sant√© PRODUCTION..."
        
        if curl -f http://localhost:$PORT/api/health > /dev/null 2>&1; then
            log "‚úÖ PRODUCTION d√©ploy√©e avec succ√®s !"
            log "üåê Site en ligne: https://$DOMAIN"
            
            # Notification Slack/Discord (optionnel)
            # curl -X POST -H 'Content-type: application/json' \
            #   --data "{\"text\":\"‚úÖ Portfolio Valentine PRODUCTION d√©ploy√© ! https://$DOMAIN\"}" \
            #   $SLACK_WEBHOOK_URL
            
        else
            log "‚ùå ERREUR: L'application PRODUCTION ne r√©pond pas"
            log "üìã Logs: sudo journalctl -u $SERVICE_NAME -f"
            exit 1
        fi
        
        log "üéâ D√©ploiement PRODUCTION termin√© !"
    else
        log "‚ÑπÔ∏è  Push sur branche $refname ignor√© (PRODUCTION accepte uniquement '$BRANCH')"
    fi
done