#!/bin/bash

# Hook Git post-receive PREPROD
# Fichier: /var/www/portfolio-valentine-preprod.git/hooks/post-receive  
# Branch: preprod → https://preview.valentine-arnaly.com

WORK_TREE="/var/www/portfolio-valentine-preprod"
GIT_DIR="/var/www/portfolio-valentine-preprod.git"
SERVICE_NAME="portfolio-valentine-preprod"
BRANCH="preprod"
PORT="3002"
DOMAIN="preview.valentine-arnaly.com"

# Fonction de log avec timestamp
log() {
    echo "[PREPROD $(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# Vérifier la branche
while read oldrev newrev refname; do
    if [[ $refname == "refs/heads/$BRANCH" ]]; then
        log "🧪 Déploiement PREPROD déclenché (branch: $BRANCH)"
        
        # Checkout des fichiers
        log "📁 Mise à jour des fichiers..."
        git --git-dir=$GIT_DIR --work-tree=$WORK_TREE checkout -f $BRANCH
        
        cd $WORK_TREE
        
        # Installation et build
        log "📦 Installation des dépendances..."
        npm run install:all > /dev/null 2>&1
        
        if [ $? -ne 0 ]; then
            log "⚠️  ERREUR: Installation des dépendances échouée (PREPROD)"
            # En preprod, on continue même si erreur (moins critique)
        fi
        
        log "🔨 Build de l'application..."
        npm run build > /dev/null 2>&1
        
        if [ $? -ne 0 ]; then
            log "⚠️  ERREUR: Build échoué (PREPROD)"
            # En preprod, on continue pour débugger
        fi
        
        # Redémarrage du service
        log "🔄 Redémarrage du service PREPROD..."
        sudo systemctl restart $SERVICE_NAME
        
        # Test de santé
        sleep 3
        log "🏥 Test de santé PREPROD..."
        
        if curl -f http://localhost:$PORT/api/health > /dev/null 2>&1; then
            log "✅ PREPROD déployée avec succès !"
            log "🌐 Preview disponible: https://$DOMAIN"
            log "👩‍💼 Prêt pour validation cliente !"
            
            # Notification avec lien preview
            # curl -X POST -H 'Content-type: application/json' \
            #   --data "{\"text\":\"🧪 Portfolio Valentine PREVIEW mis à jour ! Test: https://$DOMAIN\"}" \
            #   $SLACK_WEBHOOK_URL
            
        else
            log "⚠️  L'application PREPROD ne répond pas correctement"
            log "📋 Logs: sudo journalctl -u $SERVICE_NAME -f"
            log "💡 C'est normal en PREPROD, check les logs pour débugger"
        fi
        
        log "🎭 Déploiement PREPROD terminé !"
    else
        log "ℹ️  Push sur branche $refname ignoré (PREPROD accepte uniquement '$BRANCH')"
    fi
done