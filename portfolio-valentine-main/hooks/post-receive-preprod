#!/bin/bash

# Hook Git post-receive PREPROD
# Fichier: /var/www/portfolio-valentine-preprod.git/hooks/post-receive  
# Branch: preprod â†’ https://preview.valentine-arnaly.com

WORK_TREE="/var/www/portfolio-valentine-preprod"
GIT_DIR="/var/www/portfolio-valentine-preprod.git"
SERVICE_NAME="portfolio-valentine-preprod"
BRANCH="preprod"
PORT="3002"
DOMAIN="preview.valentine-arnaly.com"

# Fonction de log avec timestamp
log() {
    echo "[PREPROD $(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# VÃ©rifier la branche
while read oldrev newrev refname; do
    if [[ $refname == "refs/heads/$BRANCH" ]]; then
        log "ğŸ§ª DÃ©ploiement PREPROD dÃ©clenchÃ© (branch: $BRANCH)"
        
        # Checkout des fichiers
        log "ğŸ“ Mise Ã  jour des fichiers..."
        git --git-dir=$GIT_DIR --work-tree=$WORK_TREE checkout -f $BRANCH
        
        cd $WORK_TREE
        
        # Installation et build
        log "ğŸ“¦ Installation des dÃ©pendances..."
        npm run install:all > /dev/null 2>&1
        
        if [ $? -ne 0 ]; then
            log "âš ï¸  ERREUR: Installation des dÃ©pendances Ã©chouÃ©e (PREPROD)"
            # En preprod, on continue mÃªme si erreur (moins critique)
        fi
        
        log "ğŸ”¨ Build de l'application..."
        npm run build > /dev/null 2>&1
        
        if [ $? -ne 0 ]; then
            log "âš ï¸  ERREUR: Build Ã©chouÃ© (PREPROD)"
            # En preprod, on continue pour dÃ©bugger
        fi
        
        # RedÃ©marrage du service
        log "ğŸ”„ RedÃ©marrage du service PREPROD..."
        sudo systemctl restart $SERVICE_NAME
        
        # Test de santÃ©
        sleep 3
        log "ğŸ¥ Test de santÃ© PREPROD..."
        
        if curl -f http://localhost:$PORT/api/health > /dev/null 2>&1; then
            log "âœ… PREPROD dÃ©ployÃ©e avec succÃ¨s !"
            log "ğŸŒ Preview disponible: https://$DOMAIN"
            log "ğŸ‘©â€ğŸ’¼ PrÃªt pour validation cliente !"
            
            # Notification avec lien preview
            # curl -X POST -H 'Content-type: application/json' \
            #   --data "{\"text\":\"ğŸ§ª Portfolio Valentine PREVIEW mis Ã  jour ! Test: https://$DOMAIN\"}" \
            #   $SLACK_WEBHOOK_URL
            
        else
            log "âš ï¸  L'application PREPROD ne rÃ©pond pas correctement"
            log "ğŸ“‹ Logs: sudo journalctl -u $SERVICE_NAME -f"
            log "ğŸ’¡ C'est normal en PREPROD, check les logs pour dÃ©bugger"
        fi
        
        log "ğŸ­ DÃ©ploiement PREPROD terminÃ© !"
    else
        log "â„¹ï¸  Push sur branche $refname ignorÃ© (PREPROD accepte uniquement '$BRANCH')"
    fi
done